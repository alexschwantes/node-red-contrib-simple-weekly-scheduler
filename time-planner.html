<script type="text/x-red" data-template-name="time-planner">
	<div class="form-row">
		<link rel='stylesheet' href='time-planner/js/jquery.weekcalendar.css' />
		<style type="text/css">
		.wc-business-hours {
			font-size: 1.0em;
		}
		</style>
		<div id="calendar" style="width: 100%; height: 500px"></div>
	</div>
	<div class="form-row">
		<label for="node-input-startPayload"> Start Payload</label>
		<input type="text" id="node-input-startPayload" placeholder="start"></input>
		<input type="hidden" id="node-input-startPayloadType">
	</div>
	<div class="form-row">
		<label for="node-input-endPayload"> End Payload</label>
		<input type="text" id="node-input-endPayload" placeholder="end"></input>
		<input type="hidden" id="node-input-endPayloadType">
	</div>
	<div class="form-row">
		<label for="node-input-topic"><i class="fa fa-tag"></i> Topic</label>
		<input type="text" id="node-input-topic" placeholder="Topic"></input>
	</div>
	<div class="form-row">
		<label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
		<input type="text" id="node-input-name" placeholder="Name"></input>
	</div>
</script>

<script type="text/x-red" data-help-name="time-planner">
	<p>A node to schedule events over a given week</p>
	<p>The node will emit a message at the start and end of the event of the form</p>
	<pre>
{
  topic: "some/topic",
  event: {
    start: "2009-04-28T07:00:00.000Z",
    end: "2009-04-28T17:00:00.000Z",
    id: "1"},
  payload: "start"
}
	</pre>
</script>

<script type="text/javascript">
	RED.nodes.registerType('time-planner',{
		category: 'input',
		color:"#DEBD5C",
		defaults: {
			events: {value:"[]"},
			topic: {value:""},
			startPayload: {value:"start"},
			startPayloadType: {value:"str"},
			endPayload: {value:"end"},
			endPayloadType: {value:"str"},
			name: {value:""}
		},
		inputs: 0,
		outputs: 1,
		icon: 'hash.png',
		label: function(){
			return this.name? this.name: 'Simple Scheduler'
		},
		oneditprepare: function() {
			var node = this;
			var setup = function(n) {
				var events = JSON.parse(n.events);
				var id = events.length;

				$('#calendar').weekCalendar({
					date: new Date('2000-01-01T12:00:00.000+00:00'),
					minDate: new Date('2009-05-01T13:15:00.000+00:00'),
					maxDate: new Date('2009-05-20T13:15:00.000+00:00'),
					data: events,
					timeslotHeight: 15,
					timeslotsPerHour: 4,
					defaultEventLength: 1,
					use24Hour: true,
					showHeader: false,
					getHeaderDate: function(date, element){
						var d=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
						return d[date.getDay()];
					},
					height: function($calendar) {
						return $('#calendar').parent().height();
					},
					newEventText: "",
					// eventHeader: function(calEvent, calendar) {
					// 	return "";
					// },
					eventBody: function(calEvent, calendar) {
						return "";
					},
					// eventResize : function(newCalEvent, oldCalEcent, element) {

					// },
					// eventDrop: function (newCalEvent, oldCalEvent, element) {

					// },
					// beforeEventNew: function(calEvent, $event) {
					// 	calEvent.id = id++;
					// 	calEvent.title = "";
					// }, 
					eventNew: function(calEvent, $event) {
						calEvent.id = id++;
						calEvent.title = "";
					},
					eventClick: function(calEvent, $event) {
						$('#calendar').weekCalendar('removeEvent', calEvent.id);
					}
				});

				if(this.startPayloadType == null) {
					this.startPayloadType = "str";
				}
				$("#node-input-startPayloadType").val(this.startPayloadType);

				$("#node-input-startPayload").typedInput({
					default: 'str',
					typeField: $("#node-input-startPayloadType"),
					types:['flow','global','str','num','bool','json']
				});

				if(this.endPayloadType == null) {
					this.endPayloadType = "str";
				}
				$("#node-input-endPayloadType").val(this.endPayloadType);

				$("#node-input-endPayload").typedInput({
					default: 'str',
					typeField: $("#node-input-endPayloadType"),
					types:['flow','global','str','num','bool','json']
				});


			}

			$.getScript('time-planner/js/date.js')
			.done(function(data, textStatus, jqxhr) {
			  $.getScript('time-planner/js/jquery.weekcalendar.js')
			  .done(function(data, textStatus, jqxhr){
				setup(node);
			  })
			  .fail(function(jqxhr, settings, exception ){
				console.log("failed to load fullcalendar.js");
				console.log(exception);
				console.log(exception.stack);
			  });
			})
			.fail(function(jqxhr, settings, exception ) {
			  console.log("failed to load moment.js");
			  console.log(exception);
			  console.log(exception.stack);
			});
		},
		oneditsave: function() {
			var n = this;
			var events = $('#calendar').weekCalendar('serializeEvents');
			for (var i=0; i<events.length; i++) {
				events[i].id = i;
			}
			n.events = JSON.stringify(events);
			delete window.calendar;
		},
		oneditresize: function() {

		}
	});
</script>